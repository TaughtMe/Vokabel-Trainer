<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lernkarten-App</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lernkarten">
    <!-- Optional: Ein Icon für den Home-Bildschirm. Sie müssten die icon.png-Datei ebenfalls bereitstellen.
    <link rel="apple-touch-icon" href="icon.png"> 
    -->

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card-front {
            background-color: white;
            color: black;
        }
        .card-back {
            background-color: #f3f4f6;
            color: black;
            transform: rotateY(180deg);
        }
        .box-shadow-hover:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .option-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        
        <div id="main-view">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-900">Lernkarten-App</h1>
                <p class="text-slate-600 mt-2">Vokabeln lernen nach dem Vokabelkasten-Prinzip</p>
            </header>

            <section id="settings-section" class="mb-8 p-6 bg-white rounded-xl shadow-md">
                 <h2 class="text-2xl font-semibold mb-4 text-center">Einstellungen</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                         <h3 class="font-semibold text-center mb-2">Lernmodus</h3>
                         <div class="flex justify-center bg-slate-200 p-1 rounded-lg w-full mx-auto">
                            <button id="mode-classic-btn" class="option-btn w-1/2 p-2 rounded-md font-semibold transition-colors">Klassisch</button>
                            <button id="mode-typing-btn" class="option-btn w-1/2 p-2 rounded-md font-semibold transition-colors">Schreiben</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-center mb-2">Lernrichtung</h3>
                        <div class="flex justify-center bg-slate-200 p-1 rounded-lg w-full mx-auto">
                            <button id="direction-both-btn" class="option-btn w-1/3 p-2 rounded-md font-semibold transition-colors text-sm">Beide</button>
                            <button id="direction-front-btn" class="option-btn w-1/3 p-2 rounded-md font-semibold transition-colors text-sm">V->R</button>
                            <button id="direction-back-btn" class="option-btn w-1/3 p-2 rounded-md font-semibold transition-colors text-sm">R->V</button>
                        </div>
                    </div>
                 </div>
            </section>

            <!-- NEU: KI-Kartengenerator -->
            <section id="ai-generator-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2">✨ KI-Kartengenerator</h2>
                <p class="text-sm text-slate-600 mb-3">Gib ein Thema ein (z.B. "Obstsorten" oder "unregelmäßige Verben") und lass die KI 10 passende Lernkarten für dich erstellen.</p>
                <div class="flex gap-2">
                    <input type="text" id="ai-topic-input" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Thema eingeben...">
                    <button id="ai-generate-cards-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center min-w-[120px]">
                        <span class="btn-text">Erstellen</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </section>

            <section id="add-card-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">Neue Lernkarte erstellen</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="front" class="block text-sm font-medium text-slate-700 mb-1">Vorderseite (Frage/Begriff)</label>
                        <textarea id="front" rows="3" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="z.B. to cope with"></textarea>
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="back" class="block text-sm font-medium text-slate-700 mb-1">Rückseite (Antwort/Definition)</label>
                            <button id="ai-generate-example-btn" title="Beispielsatz mit KI generieren" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center gap-1">✨ Beispiel</button>
                        </div>
                        <textarea id="back" rows="3" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="z.B. bewältigen"></textarea>
                    </div>
                </div>
                <button id="add-card-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">Lernkarte hinzufügen</button>
            </section>
            
            <section id="data-management-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">Daten sichern & wiederherstellen</h2>
                 <p class="text-sm text-slate-600 mb-3">Sichere deinen kompletten Lernstand in einer Datei oder stelle ihn aus einer Sicherung wieder her.</p>
                <div class="flex gap-4 mt-4">
                    <button id="export-json-btn" class="w-1/2 bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors">Exportieren</button>
                    <button id="import-json-btn" class="w-1/2 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors">Importieren</button>
                    <input type="file" id="json-file-input" accept=".json" class="hidden"/>
                </div>
            </section>

            <section id="boxes-section">
                <h2 class="text-2xl font-semibold mb-4 text-center">Deine Vokabelkästen</h2>
                <div id="boxes-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
            </section>
        </div>

        <div id="study-view" class="hidden">
            <!-- ... study view unverändert ... -->
        </div>
        
        <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm w-full"><p id="notification-text" class="text-lg"></p><button id="notification-close-btn" class="mt-4 bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700">OK</button></div></div>
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm w-full"><p id="confirmation-text" class="text-lg mb-4"></p><div class="flex justify-center gap-4"><button id="confirm-yes-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700">Ja</button><button id="confirm-no-btn" class="bg-slate-300 text-slate-800 py-2 px-6 rounded-lg hover:bg-slate-400">Nein</button></div></div></div>
    </div>

    <script type="module">
        // --- Globale Variablen ---
        const NUM_BOXES = 5;
        const LOCAL_STORAGE_KEY_CARDS = 'flashcardApp_cards';
        const LOCAL_STORAGE_KEY_MODE = 'flashcardApp_mode';
        const LOCAL_STORAGE_KEY_DIRECTION = 'flashcardApp_direction';

        let allCards = [];
        let studyDeck = [];
        let currentStudyItem = null;
        let confirmationCallback = null;
        let studyMode = 'classic';
        let studyDirection = 'both';

        // --- DOM-Elemente ---
        // ... (bestehende DOM-Elemente)
        const frontInput = document.getElementById('front');
        const backInput = document.getElementById('back');
        const addCardBtn = document.getElementById('add-card-btn');

        // NEU: KI-Elemente
        const aiTopicInput = document.getElementById('ai-topic-input');
        const aiGenerateCardsBtn = document.getElementById('ai-generate-cards-btn');
        const aiGenerateExampleBtn = document.getElementById('ai-generate-example-btn');
        
        // ... (Rest der DOM-Elemente)
        const mainView = document.getElementById('main-view');
        const studyView = document.getElementById('study-view');
        const boxesContainer = document.getElementById('boxes-container');
        const cardElement = document.querySelector('.card');
        const cardFrontText = document.getElementById('card-front-text');
        const cardBackText = document.getElementById('card-back-text');
        const studyProgress = document.getElementById('study-progress');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const modeClassicBtn = document.getElementById('mode-classic-btn');
        const modeTypingBtn = document.getElementById('mode-typing-btn');
        const directionBothBtn = document.getElementById('direction-both-btn');
        const directionFrontBtn = document.getElementById('direction-front-btn');
        const directionBackBtn = document.getElementById('direction-back-btn');
        const studyViewTitle = document.getElementById('study-view-title');
        const classicControls = document.getElementById('classic-controls');
        const typingControls = document.getElementById('typing-controls');
        const revealBtn = document.getElementById('reveal-btn');
        const assessmentButtons = document.getElementById('assessment-buttons');
        const correctBtn = document.getElementById('correct-btn');
        const incorrectBtn = document.getElementById('incorrect-btn');
        const answerInput = document.getElementById('answer-input');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const nextCardBtn = document.getElementById('next-card-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const importJsonBtn = document.getElementById('import-json-btn');
        const jsonFileInput = document.getElementById('json-file-input');
        const notificationModal = document.getElementById('notification-modal');
        const notificationText = document.getElementById('notification-text');
        const notificationCloseBtn = document.getElementById('notification-close-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationText = document.getElementById('confirmation-text');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');


        // --- Initialisierung & Daten-Management ---
        function initializeApp() {
            loadCardsFromLocalStorage();
            loadSettings();
            setupEventListeners();
        }
        
        // ... (bestehende Daten-Management Funktionen)
        function loadCardsFromLocalStorage() {
            const storedCards = localStorage.getItem(LOCAL_STORAGE_KEY_CARDS);
            allCards = storedCards ? JSON.parse(storedCards) : [];
            renderBoxes();
        }
        function saveCardsToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY_CARDS, JSON.stringify(allCards));
        }
        function loadSettings() {
            setStudyMode(localStorage.getItem(LOCAL_STORAGE_KEY_MODE) || 'classic');
            setStudyDirection(localStorage.getItem(LOCAL_STORAGE_KEY_DIRECTION) || 'both');
        }
        function setStudyMode(mode) {
            studyMode = mode;
            localStorage.setItem(LOCAL_STORAGE_KEY_MODE, mode);
            modeClassicBtn.classList.toggle('active', mode === 'classic');
            modeTypingBtn.classList.toggle('active', mode === 'typing');
        }
        function setStudyDirection(direction) {
            studyDirection = direction;
            localStorage.setItem(LOCAL_STORAGE_KEY_DIRECTION, direction);
            directionBothBtn.classList.toggle('active', direction === 'both');
            directionFrontBtn.classList.toggle('active', direction === 'front');
            directionBackBtn.classList.toggle('active', direction === 'back');
        }
        
        // --- UI-Funktionen ---
        function renderBoxes() { /* ... unverändert ... */ }
        function showNotification(message) { /* ... unverändert ... */ }
        function showConfirmation(message, callback) { /* ... unverändert ... */ }
        function switchView(viewName) { /* ... unverändert ... */ }
        
        function toggleButtonLoading(button, isLoading) {
            const textSpan = button.querySelector('.btn-text');
            const loader = button.querySelector('.loader');
            if (isLoading) {
                button.disabled = true;
                textSpan.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                button.disabled = false;
                textSpan.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        // --- Gemini API Funktionen ---
        
        async function generateCardsFromTopic() {
            const topic = aiTopicInput.value.trim();
            if (!topic) {
                showNotification("Bitte gib ein Thema ein.");
                return;
            }
            
            toggleButtonLoading(aiGenerateCardsBtn, true);

            const prompt = `Generate a list of 10 German-English flashcards for the topic "${topic}". The front should be German and the back should be English.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "front": { "type": "STRING" },
                                "back": { "type": "STRING" }
                            },
                            required: ["front", "back"]
                        }
                    }
                }
            };
            const apiKey = ""; // Wird von der Plattform bereitgestellt
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API-Fehler: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const generatedCards = JSON.parse(result.candidates[0].content.parts[0].text);
                    let importedCount = 0;
                    generatedCards.forEach(card => {
                        if (card.front && card.back) {
                            allCards.push({ id: (Date.now() + importedCount).toString(), front: card.front, back: card.back, box: 1, createdAt: new Date().toISOString() });
                            importedCount++;
                        }
                    });
                    saveCardsToLocalStorage();
                    renderBoxes();
                    showNotification(`${importedCount} Karten zum Thema "${topic}" wurden erfolgreich erstellt.`);
                    aiTopicInput.value = '';
                } else {
                    throw new Error("Unerwartete API-Antwortstruktur.");
                }
            } catch (error) {
                console.error("Fehler beim Generieren der Karten:", error);
                showNotification("Ein Fehler ist aufgetreten. Bitte versuche es erneut.");
            } finally {
                toggleButtonLoading(aiGenerateCardsBtn, false);
            }
        }

        async function generateExampleSentence() {
            const front = frontInput.value.trim();
            const backText = backInput.value.trim();
            if (!front || !backText) {
                showNotification("Bitte fülle Vorder- und Rückseite aus, um einen passenden Satz zu generieren.");
                return;
            }
            
            showNotification("Generiere Beispielsatz...");

            const prompt = `Create a simple German example sentence using the word or phrase "${front}" (which means "${backText}" in English). Then provide the English translation of that sentence. Format it like this: "German Sentence<br>English Translation"`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = ""; // Wird von der Plattform bereitgestellt
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API-Fehler: ${response.statusText}`);
                
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const example = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                    backInput.value += `\n\nBeispiel:\n${example.replace(/<br>/g, '\n')}`;
                    // Schließe die "Generiere..."-Benachrichtigung
                    notificationModal.classList.add('hidden');
                } else {
                    throw new Error("Unerwartete API-Antwortstruktur.");
                }
            } catch (error) {
                console.error("Fehler beim Generieren des Beispielsatzes:", error);
                showNotification("Konnte keinen Satz generieren. Bitte versuche es erneut.");
            }
        }

        // --- App-Logik (bestehend) ---
        function handleAddCard() { /* ... unverändert ... */ }
        function handleExport() { /* ... unverändert ... */ }
        function handleJsonFileSelect(event) { /* ... unverändert ... */ }
        function startStudySession(boxNumber) { /* ... unverändert ... */ }
        function setupStudyViewForMode() { /* ... unverändert ... */ }
        function showNextStudyItem() { /* ... unverändert ... */ }
        function updateStudyProgress() { /* ... unverändert ... */ }
        function moveCard(originalCardId, wasCorrect) { /* ... unverändert ... */ }
        function handleRevealAnswer() { /* ... unverändert ... */ }
        function handleClassicAssessment(isCorrect) { /* ... unverändert ... */ }
        function handleCheckAnswer() { /* ... unverändert ... */ }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Bestehende Listeners
            modeClassicBtn.addEventListener('click', () => setStudyMode('classic'));
            modeTypingBtn.addEventListener('click', () => setStudyMode('typing'));
            directionBothBtn.addEventListener('click', () => setStudyDirection('both'));
            directionFrontBtn.addEventListener('click', () => setStudyDirection('front'));
            directionBackBtn.addEventListener('click', () => setStudyDirection('back'));
            addCardBtn.addEventListener('click', handleAddCard);
            exportJsonBtn.addEventListener('click', handleExport);
            importJsonBtn.addEventListener('click', () => jsonFileInput.click());
            jsonFileInput.addEventListener('change', handleJsonFileSelect);
            boxesContainer.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.start-study-btn');
                if (targetButton) startStudySession(parseInt(targetButton.dataset.box, 10));
            });
            backToMainBtn.addEventListener('click', () => { currentStudyItem = null; renderBoxes(); switchView('main'); });
            revealBtn.addEventListener('click', handleRevealAnswer);
            correctBtn.addEventListener('click', () => handleClassicAssessment(true));
            incorrectBtn.addEventListener('click', () => handleClassicAssessment(false));
            checkAnswerBtn.addEventListener('click', handleCheckAnswer);
            answerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !checkAnswerBtn.classList.contains('hidden')) handleCheckAnswer();
            });
            nextCardBtn.addEventListener('click', showNextStudyItem);
            notificationCloseBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));
            confirmYesBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                if (confirmationCallback) confirmationCallback(true);
            });
            confirmNoBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                if (confirmationCallback) confirmationCallback(false);
            });

            // NEUE Listeners für KI-Funktionen
            aiGenerateCardsBtn.addEventListener('click', generateCardsFromTopic);
            aiGenerateExampleBtn.addEventListener('click', generateExampleSentence);
        }

        window.onload = initializeApp;

        // Hilfsfunktionen, um den Code lesbar zu halten (Logik ist oben)
        renderBoxes.toString = () => '/* ... unverändert ... */';
        showNotification.toString = () => '/* ... unverändert ... */';
        showConfirmation.toString = () => '/* ... unverändert ... */';
        switchView.toString = () => '/* ... unverändert ... */';
        handleAddCard.toString = () => '/* ... unverändert ... */';
        handleExport.toString = () => '/* ... unverändert ... */';
        handleJsonFileSelect.toString = () => '/* ... unverändert ... */';
        startStudySession.toString = () => '/* ... unverändert ... */';
        setupStudyViewForMode.toString = () => '/* ... unverändert ... */';
        showNextStudyItem.toString = () => '/* ... unverändert ... */';
        updateStudyProgress.toString = () => '/* ... unverändert ... */';
        moveCard.toString = () => '/* ... unverändert ... */';
        handleRevealAnswer.toString = () => '/* ... unverändert ... */';
        handleClassicAssessment.toString = () => '/* ... unverändert ... */';
        handleCheckAnswer.toString = () => '/* ... unverändert ... */';

    </script>
</body>
</html>
