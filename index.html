<!--
Copyright (c) 2024 [Ihr Name hier]
Alle Rechte vorbehalten.

Die Vervielfältigung, Verbreitung, öffentliche Zugänglichmachung oder sonstige Nutzung dieser Software,
sei es ganz oder in Teilen, ist ohne die ausdrückliche schriftliche Zustimmung des Urhebers strengstens untersagt.

Diese Software wird "wie besehen" zur Verfügung gestellt, ohne jegliche Gewährleistung, 
weder ausdrücklich noch stillschweigend.
-->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lernkarten-App</title>
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lernkarten">
    <!-- Optional: Ein Icon für den Home-Bildschirm. Sie müssten die icon.png-Datei ebenfalls bereitstellen.
    <link rel="apple-touch-icon" href="icon.png"> 
    -->

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- KORREKTUR: Tailwind Konfiguration NACH dem Laden des CDN-Skripts -->
    <script>
        tailwind.config = {
          darkMode: 'class',
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* KORREKTUR: Globale, sanfte Übergänge für alle Elemente */
        * {
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card-front {
            background-color: white;
            color: black;
        }
        .dark .card-front {
             background-color: #374151; /* gray-700 */
             color: #f3f4f6; /* gray-100 */
        }
        .card-back {
            background-color: #f3f4f6;
            color: black;
            transform: rotateY(180deg);
        }
        .dark .card-back {
            background-color: #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
        }
        .box-shadow-hover:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .option-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex flex-col min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto flex-grow relative">
        
        <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        </button>

        <!-- Ansicht für die Stapel-Auswahl -->
        <div id="deck-selection-view">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100">Meine Lernstapel <span id="version-display-decks" class="text-lg align-middle font-normal text-slate-500"></span></h1>
                <p class="text-slate-600 dark:text-slate-400 mt-2">Wähle einen Stapel oder erstelle einen neuen.</p>
            </header>
            <div id="deck-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <!-- Stapel werden hier dynamisch eingefügt -->
            </div>
            <div>
                <input type="text" id="new-deck-name" class="w-full p-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Name für neuen Stapel...">
                <button id="add-deck-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Neuen Stapel erstellen</button>
            </div>
        </div>

        <!-- Hauptansicht für einen einzelnen Stapel -->
        <div id="main-view" class="hidden">
            <header class="text-center mb-8">
                <h1 id="deck-title" class="text-4xl font-bold text-slate-900 dark:text-slate-100"></h1>
                <p class="text-slate-600 dark:text-slate-400 mt-2">Vokabeln lernen nach dem Level-Prinzip</p>
                <button id="back-to-decks-btn" class="mt-4 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-semibold">&larr; Zur Stapel-Übersicht</button>
            </header>

            <section id="settings-section" class="mb-8 p-6 bg-white dark:bg-slate-800 rounded-xl shadow-md">
                 <h2 class="text-2xl font-semibold mb-4 text-center">Einstellungen</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                         <h3 class="font-semibold text-center mb-2">Lernmodus</h3>
                         <div class="flex justify-center bg-slate-200 dark:bg-slate-700 p-1 rounded-lg w-full mx-auto">
                            <button id="mode-classic-btn" class="option-btn w-1/2 p-2 rounded-md font-semibold transition-colors">Klassisch</button>
                            <button id="mode-typing-btn" class="option-btn w-1/2 p-2 rounded-md font-semibold transition-colors">Schreiben</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-center mb-2">Lernrichtung</h3>
                        <div class="flex justify-center bg-slate-200 dark:bg-slate-700 p-1 rounded-lg w-full mx-auto">
                            <button id="direction-both-btn" class="option-btn w-1/3 p-2 rounded-md font-semibold transition-colors text-sm">Beide</button>
                            <button id="direction-front-btn" class="option-btn w-1/3 p-2 rounded-md font-semibold transition-colors text-sm">V->R</button>
                            <button id="direction-back-btn" class="option-btn w-1/3 p-2 rounded-md font-semibold transition-colors text-sm">R->V</button>
                        </div>
                    </div>
                 </div>
            </section>
            
            <section id="boxes-section" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-center">Deine Lernlevel</h2>
                <div id="boxes-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
            </section>

            <section id="add-card-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">Neue Lernkarte erstellen</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="front" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Vorderseite (Frage/Begriff)</label>
                        <textarea id="front" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="z.B. What does 'bewältigen' mean?"></textarea>
                    </div>
                    <div>
                        <label for="back" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Rückseite (Antwort/Definition)</label>
                        <textarea id="back" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="z.B. to cope with, to manage"></textarea>
                    </div>
                </div>
                <button id="add-card-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">Lernkarte hinzufügen</button>
            </section>
            
            <section id="data-management-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">Daten & Import/Export</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Karten aus CSV hinzufügen</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Fügt neue Karten aus einer CSV-Datei zu diesem Stapel hinzu. <a href="#" id="download-csv-example" class="text-blue-600 dark:text-blue-400 hover:underline">Beispiel herunterladen</a></p>
                        <button id="import-csv-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700">CSV Importieren</button>
                        <input type="file" id="csv-file-input" accept=".csv,.txt" class="hidden"/>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Stapel-Sicherung</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Exportiert oder importiert den kompletten Stapel inkl. Lernfortschritt. <a href="#" id="download-json-example" class="text-blue-600 dark:text-blue-400 hover:underline">Beispiel herunterladen</a></p>
                        <div class="flex gap-4">
                            <button id="export-json-btn" class="w-1/2 bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600">Export</button>
                            <button id="import-json-btn" class="w-1/2 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Import</button>
                            <input type="file" id="json-file-input" accept=".json" class="hidden"/>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- KORREKTUR: Fehlender HTML-Inhalt für die Lernansicht wiederhergestellt -->
        <div id="study-view" class="hidden">
             <h2 id="study-view-title" class="text-3xl font-bold text-center mb-6">Lernmodus</h2>
            <div id="card-container" class="perspective-1000 mx-auto w-full max-w-xl h-64 mb-6">
                <div class="card w-full h-full"><div class="card-inner"><div class="card-face card-front"><p id="card-front-text" class="text-2xl text-center"></p></div><div class="card-face card-back"><p id="card-back-text" class="text-xl text-center"></p></div></div></div>
            </div>
            <div id="classic-controls" class="flex flex-col items-center gap-4">
                 <button id="reveal-btn" class="w-full max-w-sm bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Antwort anzeigen</button>
                 <div id="assessment-buttons" class="hidden w-full max-w-sm flex gap-4">
                     <button id="correct-btn" class="w-1/2 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">Richtig</button>
                     <button id="incorrect-btn" class="w-1/2 bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors">Falsch</button>
                 </div>
            </div>
            <div id="typing-controls" class="flex flex-col items-center gap-4">
                <input type="text" id="answer-input" class="w-full max-w-sm p-3 border border-slate-300 rounded-lg text-center text-lg" placeholder="Antwort eingeben...">
                <button id="check-answer-btn" class="w-full max-w-sm bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Prüfen</button>
                <div id="feedback-container" class="w-full max-w-sm text-center"></div>
                <button id="next-card-btn" class="hidden w-full max-w-sm bg-slate-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-600">Weiter</button>
            </div>
            <button id="back-to-main-btn" class="mt-4 text-slate-600 hover:text-slate-900 font-medium mx-auto block">Zurück zur Übersicht</button>
            <p id="study-progress" class="text-center mt-4 text-slate-500"></p>
        </div>
        
        <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full"><p id="notification-text" class="text-lg"></p><button id="notification-close-btn" class="mt-4 bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700">OK</button></div></div>
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full"><p id="confirmation-text" class="text-lg mb-4"></p><div class="flex justify-center gap-4"><button id="confirm-yes-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700">Ja</button><button id="confirm-no-btn" class="bg-slate-300 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-2 px-6 rounded-lg hover:bg-slate-400 dark:hover:bg-slate-500">Nein</button></div></div></div>
    </div>
    
    <footer id="app-footer" class="text-center p-4 text-xs text-slate-500">
        <!-- Footer-Inhalt wird per JS eingefügt -->
    </footer>

    <script type="module">
        // --- VERSION ---
        const APP_VERSION = "1.9.4";
        const COPYRIGHT_HOLDER = "[Ihr Name hier]"; // Bitte anpassen

        // --- Globale Variablen ---
        const NUM_LEVELS = 5;
        const LOCAL_STORAGE_KEY_DECKS = 'flashcardApp_decks';
        const LOCAL_STORAGE_KEY_LEGACY_CARDS = 'flashcardApp_cards';
        const LOCAL_STORAGE_KEY_MODE = 'flashcardApp_mode';
        const LOCAL_STORAGE_KEY_DIRECTION = 'flashcardApp_direction';
        const LOCAL_STORAGE_KEY_THEME = 'flashcardApp_theme';

        let allDecks = {};
        let activeDeckId = null;
        let studyDeck = [];
        let currentStudyItem = null;
        let confirmationCallback = null;
        let studyMode = 'classic';
        let studyDirection = 'both';
        let totalInSession = 0;

        // --- DOM-Elemente ---
        const versionDisplayDecks = document.getElementById('version-display-decks');
        const appFooter = document.getElementById('app-footer');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const deckSelectionView = document.getElementById('deck-selection-view');
        const mainView = document.getElementById('main-view');
        const studyView = document.getElementById('study-view');
        const deckList = document.getElementById('deck-list');
        const newDeckNameInput = document.getElementById('new-deck-name');
        const addDeckBtn = document.getElementById('add-deck-btn');
        const deckTitle = document.getElementById('deck-title');
        const backToDecksBtn = document.getElementById('back-to-decks-btn');
        const frontInput = document.getElementById('front');
        const backInput = document.getElementById('back');
        const addCardBtn = document.getElementById('add-card-btn');
        const boxesContainer = document.getElementById('boxes-container');
        const modeClassicBtn = document.getElementById('mode-classic-btn');
        const modeTypingBtn = document.getElementById('mode-typing-btn');
        const directionBothBtn = document.getElementById('direction-both-btn');
        const directionFrontBtn = document.getElementById('direction-front-btn');
        const directionBackBtn = document.getElementById('direction-back-btn');
        const studyViewTitle = document.getElementById('study-view-title');
        const cardContainer = document.getElementById('card-container');
        const cardElement = cardContainer.querySelector('.card');
        const cardFrontText = document.getElementById('card-front-text');
        const cardBackText = document.getElementById('card-back-text');
        const classicControls = document.getElementById('classic-controls');
        const typingControls = document.getElementById('typing-controls');
        const revealBtn = document.getElementById('reveal-btn');
        const assessmentButtons = document.getElementById('assessment-buttons');
        const correctBtn = document.getElementById('correct-btn');
        const incorrectBtn = document.getElementById('incorrect-btn');
        const answerInput = document.getElementById('answer-input');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const nextCardBtn = document.getElementById('next-card-btn');
        const studyProgress = document.getElementById('study-progress');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const importJsonBtn = document.getElementById('import-json-btn');
        const jsonFileInput = document.getElementById('json-file-input');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const downloadCsvExampleBtn = document.getElementById('download-csv-example');
        const downloadJsonExampleBtn = document.getElementById('download-json-example');
        const notificationModal = document.getElementById('notification-modal');
        const notificationText = document.getElementById('notification-text');
        const notificationCloseBtn = document.getElementById('notification-close-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationText = document.getElementById('confirmation-text');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // --- Initialisierung & Daten-Management ---
        function initializeApp() {
            versionDisplayDecks.textContent = `v${APP_VERSION}`;
            appFooter.innerHTML = `&copy; ${new Date().getFullYear()} ${COPYRIGHT_HOLDER}. Alle Rechte vorbehalten.`;
            migrateLegacyData();
            loadDecksFromLocalStorage();
            loadSettings();
            setupEventListeners();
            showDeckSelectionView();
        }

        function migrateLegacyData() {
            try {
                const legacyCards = localStorage.getItem(LOCAL_STORAGE_KEY_LEGACY_CARDS);
                const decksExist = localStorage.getItem(LOCAL_STORAGE_KEY_DECKS);

                if (legacyCards && !decksExist) {
                    const cards = JSON.parse(legacyCards);
                    if (Array.isArray(cards) && cards.length > 0) {
                        const newDeckId = `deck-${Date.now()}`;
                        allDecks[newDeckId] = {
                            id: newDeckId,
                            name: "Meine alten Vokabeln",
                            cards: cards
                        };
                        saveDecksToLocalStorage();
                        localStorage.removeItem(LOCAL_STORAGE_KEY_LEGACY_CARDS);
                        showNotification("Deine bisherigen Karten wurden in einen neuen Stapel verschoben.");
                    }
                }
            } catch (e) { console.error("Fehler bei der Datenmigration:", e); }
        }
        
        function loadDecksFromLocalStorage() {
            try {
                const storedDecks = localStorage.getItem(LOCAL_STORAGE_KEY_DECKS);
                allDecks = storedDecks ? JSON.parse(storedDecks) : {};
            } catch (e) { console.error("Fehler beim Laden der Stapel:", e); allDecks = {}; }
        }

        function saveDecksToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY_DECKS, JSON.stringify(allDecks));
            } catch (e) { console.error("Fehler beim Speichern der Stapel:", e); }
        }

        function loadSettings() {
            try {
                setStudyMode(localStorage.getItem(LOCAL_STORAGE_KEY_MODE) || 'classic');
                setStudyDirection(localStorage.getItem(LOCAL_STORAGE_KEY_DIRECTION) || 'both');
                loadTheme();
            } catch (e) { console.error("Fehler beim Laden der Einstellungen:", e); }
        }

        function setStudyMode(mode) {
            studyMode = mode;
            try { localStorage.setItem(LOCAL_STORAGE_KEY_MODE, mode); } catch (e) { console.error("Fehler beim Speichern des Lernmodus:", e); }
            modeClassicBtn.classList.toggle('active', mode === 'classic');
            modeTypingBtn.classList.toggle('active', mode === 'typing');
        }

        function setStudyDirection(direction) {
            studyDirection = direction;
            try { localStorage.setItem(LOCAL_STORAGE_KEY_DIRECTION, direction); } catch (e) { console.error("Fehler beim Speichern der Lernrichtung:", e); }
            directionBothBtn.classList.toggle('active', direction === 'both');
            directionFrontBtn.classList.toggle('active', direction === 'front');
            directionBackBtn.classList.toggle('active', direction === 'back');
        }

        function loadTheme() {
            try {
                const isDark = localStorage.getItem(LOCAL_STORAGE_KEY_THEME) === 'dark' || 
                               (!localStorage.getItem(LOCAL_STORAGE_KEY_THEME) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                document.documentElement.classList.toggle('dark', isDark);
                themeToggleLightIcon.classList.toggle('hidden', isDark);
                themeToggleDarkIcon.classList.toggle('hidden', !isDark);
            } catch (e) {
                console.error("Fehler beim Laden des Themes:", e);
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY_THEME, isDark ? 'dark' : 'light');
            } catch (e) { console.error("Fehler beim Speichern des Themes:", e); }
            themeToggleLightIcon.classList.toggle('hidden', !isDark);
            themeToggleDarkIcon.classList.toggle('hidden', isDark);
        }

        // --- UI-Funktionen ---
        function showDeckSelectionView() {
            deckSelectionView.classList.remove('hidden');
            mainView.classList.add('hidden');
            studyView.classList.add('hidden');
            renderDeckList();
        }

        function showMainView(deckId) {
            activeDeckId = deckId;
            deckSelectionView.classList.add('hidden');
            mainView.classList.remove('hidden');
            deckTitle.textContent = allDecks[deckId].name;
            renderBoxes();
        }

        function renderDeckList() {
            deckList.innerHTML = '';
            if (Object.keys(allDecks).length === 0) {
                deckList.innerHTML = `<p class="col-span-full text-center text-slate-500 dark:text-slate-400">Noch keine Stapel vorhanden. Erstelle deinen ersten!</p>`;
                return;
            }
            for (const deckId in allDecks) {
                const deck = allDecks[deckId];
                const deckEl = document.createElement('div');
                deckEl.className = 'p-4 bg-white dark:bg-slate-800 rounded-lg shadow-md cursor-pointer box-shadow-hover flex justify-between items-center';
                deckEl.dataset.deckId = deck.id;
                deckEl.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-200">${deck.name}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${deck.cards.length} Karte${deck.cards.length !== 1 ? 'n' : ''}</p>
                    </div>
                    <button data-delete-id="${deck.id}" class="delete-deck-btn text-red-400 hover:text-red-600 p-2 rounded-full text-2xl leading-none">&times;</button>
                `;
                deckList.appendChild(deckEl);
            }
        }

        function renderBoxes() {
            if (!activeDeckId) return;
            const currentDeck = allDecks[activeDeckId];
            boxesContainer.innerHTML = '';
            const cardCounts = Array(NUM_LEVELS).fill(0);
            currentDeck.cards.forEach(card => {
                if(card.box >= 1 && card.box <= NUM_LEVELS) cardCounts[card.box - 1]++;
            });
            for (let i = 0; i < NUM_LEVELS; i++) {
                const boxIndex = i + 1;
                const count = cardCounts[i];
                let tileBgClasses = 'bg-white dark:bg-slate-800';
                let textColorClasses = 'text-slate-800 dark:text-slate-200';
                let countColorClasses = count > 0 ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400 dark:text-slate-500';
                let subTextColorClasses = 'text-slate-500 dark:text-slate-400';
                let buttonClasses = 'bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 disabled:bg-slate-100 dark:disabled:bg-slate-800 disabled:text-slate-400 dark:disabled:text-slate-500';

                if (boxIndex === 3) {
                    tileBgClasses = 'bg-gradient-to-br from-yellow-600 to-amber-800';
                    textColorClasses = 'text-white';
                    countColorClasses = 'text-white';
                    subTextColorClasses = 'text-amber-100';
                    buttonClasses = 'bg-white/30 text-white hover:bg-white/50 disabled:bg-white/10 disabled:text-white/50';
                } else if (boxIndex === 4) {
                    tileBgClasses = 'bg-gradient-to-br from-slate-400 to-slate-600';
                    textColorClasses = 'text-white';
                    countColorClasses = 'text-white';
                    subTextColorClasses = 'text-slate-100';
                    buttonClasses = 'bg-white/30 text-white hover:bg-white/50 disabled:bg-white/10 disabled:text-white/50';
                } else if (boxIndex === 5) {
                    tileBgClasses = 'bg-gradient-to-br from-amber-400 to-yellow-500';
                    textColorClasses = 'text-white';
                    countColorClasses = 'text-white';
                    subTextColorClasses = 'text-yellow-100';
                    buttonClasses = 'bg-white/30 text-white hover:bg-white/50 disabled:bg-white/10 disabled:text-white/50';
                }

                const boxEl = document.createElement('div');
                boxEl.className = `p-4 ${tileBgClasses} rounded-lg shadow-md text-center transition-all duration-300 ${count > 0 ? 'cursor-pointer box-shadow-hover' : ''}`;
                boxEl.innerHTML = `<h3 class="font-bold text-lg ${textColorClasses}">Level ${boxIndex}</h3><p class="text-3xl font-semibold my-2 ${countColorClasses}">${count}</p><p class="text-sm ${subTextColorClasses} mb-4">Karte${count !== 1 ? 'n' : ''}</p><button data-box="${boxIndex}" class="start-study-btn w-full font-semibold py-2 px-4 rounded-lg transition-colors disabled:cursor-not-allowed ${buttonClasses}" ${count === 0 ? 'disabled' : ''}>Lernen</button>`;
                boxesContainer.appendChild(boxEl);
            }
        }
        
        function showNotification(message) {
            notificationText.textContent = message;
            notificationModal.classList.remove('hidden');
        }
        function showConfirmation(message, callback) {
            confirmationText.textContent = message;
            confirmationCallback = callback;
            confirmationModal.classList.remove('hidden');
        }
        function switchView(viewName) {
            mainView.classList.toggle('hidden', viewName === 'study');
            studyView.classList.toggle('hidden', viewName !== 'study');
        }
        
        // --- App-Logik ---
        function handleAddDeck() {
            const name = newDeckNameInput.value.trim();
            if (!name) return showNotification("Bitte gib einen Namen für den neuen Stapel ein.");
            const newDeckId = `deck-${Date.now()}`;
            allDecks[newDeckId] = { id: newDeckId, name: name, cards: [] };
            saveDecksToLocalStorage();
            newDeckNameInput.value = '';
            showMainView(newDeckId);
        }

        function handleDeleteDeck(deckId) {
            const deckName = allDecks[deckId].name;
            showConfirmation(`Möchtest du den Stapel "${deckName}" wirklich löschen? Alle Karten darin gehen verloren.`, (confirmed) => {
                if (confirmed) {
                    delete allDecks[deckId];
                    saveDecksToLocalStorage();
                    renderDeckList();
                }
            });
        }

        function handleAddCard() {
            if (!activeDeckId) return;
            const front = frontInput.value.trim();
            const back = backInput.value.trim();
            if (!front || !back) return showNotification("Bitte fülle beide Seiten der Karte aus.");
            
            allDecks[activeDeckId].cards.push({ id: Date.now().toString(), front, back, box: 1, createdAt: new Date().toISOString() });
            saveDecksToLocalStorage();
            renderBoxes();
            frontInput.value = ''; backInput.value = ''; frontInput.focus();
            showNotification("Lernkarte erfolgreich hinzugefügt!");
        }

        function handleExport() {
            if (!activeDeckId) return;
            const deck = allDecks[activeDeckId];
            if (deck.cards.length === 0) return showNotification("Dieser Stapel ist leer.");
            
            const dataStr = JSON.stringify(deck, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${deck.name.replace(/\s/g, '_')}-backup.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function handleJsonFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            showConfirmation("Achtung! Das Importieren erstellt einen NEUEN Stapel aus der Datei. Fortfahren?", (confirmed) => {
                if (confirmed) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedDeck = JSON.parse(e.target.result);
                            if (importedDeck.id && importedDeck.name && Array.isArray(importedDeck.cards)) {
                                const newId = `deck-${Date.now()}`;
                                allDecks[newId] = { ...importedDeck, id: newId };
                                saveDecksToLocalStorage();
                                renderDeckList();
                                showNotification(`Stapel "${importedDeck.name}" erfolgreich importiert.`);
                            } else { throw new Error("Ungültiges Stapel-Format."); }
                        } catch (error) { showNotification("Fehler: Die Datei ist beschädigt oder hat ein falsches Format."); }
                    };
                    reader.readAsText(file);
                }
                jsonFileInput.value = '';
            });
        }

        function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file || !activeDeckId) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                
                if (rows.length === 0) {
                    return showNotification("Die CSV-Datei ist leer oder ungültig.");
                }

                let importedCount = 0;
                rows.forEach(row => {
                    const separatorIndex = row.indexOf(',');
                    let front, back;

                    if (separatorIndex !== -1) {
                        front = row.substring(0, separatorIndex).trim();
                        back = row.substring(separatorIndex + 1).trim();
                    }

                    if (front && back) {
                        allDecks[activeDeckId].cards.push({
                            id: `card-${Date.now()}-${importedCount}`,
                            front: front,
                            back: back,
                            box: 1,
                            createdAt: new Date().toISOString()
                        });
                        importedCount++;
                    }
                });

                if (importedCount > 0) {
                    saveDecksToLocalStorage();
                    renderBoxes();
                    showNotification(`${importedCount} Karte(n) erfolgreich zum Stapel hinzugefügt.`);
                } else {
                    showNotification("Keine gültigen Karten in der Datei gefunden. Format: Vorderseite,Rückseite");
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        function handleDownloadExample(type) {
            let content, filename, mimeType;
            if (type === 'csv') {
                content = "Vorderseite,Rückseite\ndog,Hund\ncat,Katze";
                filename = "beispiel.csv";
                mimeType = "text/csv;charset=utf-8;";
            } else { // json
                const exampleDeck = {
                    id: "deck-beispiel-123",
                    name: "Beispiel-Stapel",
                    cards: [
                        { id: "card-1", front: "the example", back: "das Beispiel", box: 1, createdAt: new Date().toISOString() }
                    ]
                };
                content = JSON.stringify(exampleDeck, null, 2);
                filename = "beispiel.json";
                mimeType = "application/json;charset=utf-8;";
            }

            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function startStudySession(boxNumber) {
            if (!activeDeckId) return;
            const cardsInBox = allDecks[activeDeckId].cards.filter(card => card.box === boxNumber);
            if (cardsInBox.length === 0) return showNotification(`Level ${boxNumber} ist leer.`);
            
            studyDeck = [];
            cardsInBox.forEach(originalCard => {
                let question, answer;
                if (studyDirection === 'front') { question = originalCard.front; answer = originalCard.back; }
                else if (studyDirection === 'back') { question = originalCard.back; answer = originalCard.front; }
                else { if (Math.random() < 0.5) { question = originalCard.front; answer = originalCard.back; } else { question = originalCard.back; answer = originalCard.front; } }
                studyDeck.push({ question, answer, originalCardId: originalCard.id });
            });
            studyDeck.sort(() => Math.random() - 0.5);
            totalInSession = studyDeck.length;
            
            setupStudyViewForMode();
            switchView('study');
            showNextStudyItem();
        }

        function setupStudyViewForMode() {
            const isClassic = studyMode === 'classic';
            studyViewTitle.textContent = isClassic ? 'Lernmodus: Klassisch' : 'Lernmodus: Schreiben';
            classicControls.style.display = isClassic ? 'flex' : 'none';
            typingControls.style.display = isClassic ? 'none' : 'flex';
        }

        function showNextStudyItem() {
            cardElement.classList.remove('flipped');
            feedbackContainer.innerHTML = '';
            
            if (studyDeck.length > 0) {
                currentStudyItem = studyDeck.pop();
                cardFrontText.textContent = currentStudyItem.question;
                cardBackText.textContent = currentStudyItem.answer;
                
                if (studyMode === 'classic') {
                    revealBtn.classList.remove('hidden');
                    assessmentButtons.classList.add('hidden');
                } else {
                    answerInput.value = '';
                    answerInput.disabled = false;
                    checkAnswerBtn.classList.remove('hidden');
                    nextCardBtn.classList.add('hidden');
                    answerInput.focus();
                }
                updateStudyProgress();
            } else {
                showNotification("Gut gemacht! Du hast alle Karten in diesem Level durchgearbeitet.");
                currentStudyItem = null;
                renderBoxes();
                showMainView(activeDeckId);
            }
        }
        
        function updateStudyProgress() {
            const done = totalInSession - studyDeck.length;
            studyProgress.textContent = `Karte ${done} von ${totalInSession}`;
        }
        
        function moveCard(originalCardId, wasCorrect) {
            if (!activeDeckId) return;
            const cardIndex = allDecks[activeDeckId].cards.findIndex(card => card.id === originalCardId);
            if (cardIndex !== -1) {
                const currentBox = allDecks[activeDeckId].cards[cardIndex].box;
                const newBox = wasCorrect ? Math.min(NUM_LEVELS, currentBox + 1) : 1;
                allDecks[activeDeckId].cards[cardIndex].box = newBox;
                saveDecksToLocalStorage();
            }
        }
        
        function handleRevealAnswer() {
            cardElement.classList.add('flipped');
            revealBtn.classList.add('hidden');
            assessmentButtons.classList.remove('hidden');
        }

        function handleClassicAssessment(isCorrect) {
            if (!currentStudyItem) return;
            moveCard(currentStudyItem.originalCardId, isCorrect);
            setTimeout(showNextStudyItem, 400);
        }

        function handleCheckAnswer() {
            const userAnswer = answerInput.value.trim().toLowerCase();
            const correctAnswer = currentStudyItem.answer.trim().toLowerCase();
            const isCorrect = userAnswer === correctAnswer;
            
            cardElement.classList.add('flipped');
            answerInput.disabled = true;
            checkAnswerBtn.classList.add('hidden');
            nextCardBtn.classList.remove('hidden');

            if (isCorrect) {
                feedbackContainer.innerHTML = `<p class="text-green-600 font-bold">Korrekt!</p>`;
            } else {
                feedbackContainer.innerHTML = `<p class="text-red-600 font-bold">Leider falsch.</p><p class="text-sm text-slate-600 dark:text-slate-400">Richtige Antwort: ${currentStudyItem.answer}</p>`;
            }

            moveCard(currentStudyItem.originalCardId, isCorrect);
        }
        
        // --- Event Listeners ---
        function setupEventListeners() {
            modeClassicBtn.addEventListener('click', () => setStudyMode('classic'));
            modeTypingBtn.addEventListener('click', () => setStudyMode('typing'));
            directionBothBtn.addEventListener('click', () => setStudyDirection('both'));
            directionFrontBtn.addEventListener('click', () => setStudyDirection('front'));
            directionBackBtn.addEventListener('click', () => setStudyDirection('back'));
            
            addDeckBtn.addEventListener('click', handleAddDeck);
            backToDecksBtn.addEventListener('click', showDeckSelectionView);
            deckList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-deck-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    handleDeleteDeck(deleteBtn.dataset.deleteId);
                    return;
                }
                const deckEl = e.target.closest('[data-deck-id]');
                if (deckEl) {
                    showMainView(deckEl.dataset.deckId);
                }
            });

            addCardBtn.addEventListener('click', handleAddCard);
            exportJsonBtn.addEventListener('click', handleExport);
            importJsonBtn.addEventListener('click', () => jsonFileInput.click());
            jsonFileInput.addEventListener('change', handleJsonFileSelect);
            importCsvBtn.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', handleCsvImport);
            downloadCsvExampleBtn.addEventListener('click', (e) => { e.preventDefault(); handleDownloadExample('csv'); });
            downloadJsonExampleBtn.addEventListener('click', (e) => { e.preventDefault(); handleDownloadExample('json'); });

            boxesContainer.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.start-study-btn');
                if (targetButton) startStudySession(parseInt(targetButton.dataset.box, 10));
            });
            
            backToMainBtn.addEventListener('click', () => { currentStudyItem = null; renderBoxes(); showMainView(activeDeckId); });
            
            revealBtn.addEventListener('click', handleRevealAnswer);
            correctBtn.addEventListener('click', () => handleClassicAssessment(true));
            incorrectBtn.addEventListener('click', () => handleClassicAssessment(false));

            checkAnswerBtn.addEventListener('click', handleCheckAnswer);
            answerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !checkAnswerBtn.classList.contains('hidden')) handleCheckAnswer();
            });
            nextCardBtn.addEventListener('click', showNextStudyItem);
            
            notificationCloseBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));
            confirmYesBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                if (confirmationCallback) confirmationCallback(true);
            });
            confirmNoBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                if (confirmationCallback) confirmationCallback(false);
            });
            themeToggleBtn.addEventListener('click', toggleTheme);
        }

        window.onload = () => {
            initializeApp();
            
            if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('Service Worker erfolgreich registriert.'))
                    .catch(err => console.error('Fehler bei der Service Worker Registrierung:', err));
            } else {
                console.log('Service Worker wird in dieser Umgebung nicht registriert (kein HTTPS oder localhost).');
            }
        };

    </script>
</body>
</html>
